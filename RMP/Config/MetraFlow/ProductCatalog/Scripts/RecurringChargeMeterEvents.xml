<?xml version="1.0" encoding="utf-8"?>
<MetraFlowScript>
    <Name>RecurringChargeMeterEvents</Name>
    <Description>Generates recurring charge, credit and correction events.</Description>
    <Parameters>
        <Parameter>
            <Name>TEMP_DIR</Name>
            <SyntaxCheckValue>C:\Temp</SyntaxCheckValue>
            <Description>Directory in which to store sort run files for sort run files.</Description>
        </Parameter>
        <Parameter>
            <Name>ID_BATCH</Name>
            <SyntaxCheckValue>0xffffffffffffffff</SyntaxCheckValue>
            <Description>Batch ID associated with the adapter run.</Description>
        </Parameter>
        <Parameter>
            <Name>ID_PI</Name>
            <SyntaxCheckValue>0</SyntaxCheckValue>
            <Description>Priceable item type id to be metered.</Description>
        </Parameter>
        <Parameter>
            <Name>PRODUCT_VIEW_NAME</Name>
            <SyntaxCheckValue>0</SyntaxCheckValue>
            <Description>Product view name of the priceable item type to be metered.</Description>
        </Parameter>
    </Parameters>
    <Script>
      <![CDATA[
-- TODO: Change rating type to be nvarchar through out to simplify metering or add ability to meter
-- a varchar to nvarchar
-- Turn off proration logic manually on advance cancellation fees because subscription end is less than the RC start for cancellation fees.
to_meter:sequential_file_scan[filename="%%TEMP_DIR%%\rc_ready_to_rate_%%ID_PI%%_%1%.mfd"];

rename_for_metering:rename[
from="_PriceableItemInstanceID", to="c__PriceableItemInstanceID",
from="_PriceableItemTemplateID", to="c__PriceableItemTemplateID",
from="_ProductOfferingID", to="c__ProductOfferingID",
from="Advance", to="c_Advance",
from="RCActionType", to="c_RCActionType",
from="ProrateOnSubscription", to="c_ProrateOnSubscription",
from="ProrateInstantly", to="c_ProrateInstantly",
from="ProrateOnUnsubscription", to="c_ProrateOnUnsubscription",
from="ProrationCycleLength", to="c_ProrationCycleLength",
from="RatingType", to="c_RatingType",
from="_SubscriptionID", to="c__SubscriptionID",
from="SubscriptionStart", to="c_SubscriptionStart",
from="SubscriptionEnd", to="c_SubscriptionEnd",
from="RCIntervalStart", to="c_RCIntervalStart",
from="RCIntervalEnd", to="c_RCIntervalEnd",
from="RCIntervalSubscriptionStart", to="c_RCIntervalSubscriptionStart",
from="RCIntervalSubscriptionEnd", to="c_RCIntervalSubscriptionEnd",
from="_PayingAccount", to="c__PayingAccount",
from="_AccountID", to="c__AccountID",
from="UnitValue", to="c_UnitValue",
from="UnitValueStart", to="c_UnitValueStart",
from="UnitValueEnd", to="c_UnitValueEnd",
from="_IntervalID", to="c__IntervalID",
from="_BillGroupID", to="c__BillGroupID",
from="BillingIntervalStart", to="c_BillingIntervalStart",
from="BillingIntervalEnd", to="c_BillingIntervalEnd",
from="BilledRateDate", to="c_BilledRateDate",
from="BillingIntervalRunDate", to="c_BillingIntervalRunDate"];

to_meter -> rename_for_metering;

meter_recurringcharges:meter[service="%%PRODUCT_VIEW_NAME%%", collectionID=%%ID_BATCH%%];

rename_for_metering -> meter_recurringcharges; 
]]></Script>
</MetraFlowScript>