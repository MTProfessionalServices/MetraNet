<?xml version="1.0" encoding="UTF-8"?>

<priceable_item>
  <name>AudioConfConn</name>
  <description>AudioConfCall child Priceable Item for Audioconferencing reference implementation</description>
  <item_type>usage</item_type>
  <relationships>
    <parent>AudioConfCall</parent>
  </relationships>
  <parameter_table>metratech.com/basetransportrate</parameter_table>
  <parameter_table>metratech.com/ldrate</parameter_table>
  <parameter_table>metratech.com/intlrate</parameter_table>
  <parameter_table>metratech.com/tollfreerate</parameter_table>
  <parameter_table>metratech.com/bridgerate</parameter_table>
  <parameter_table>metratech.com/globalactions</parameter_table>
  <parameter_table>metratech.com/includedrole</parameter_table>
  <parameter_table>metratech.com/calendar</parameter_table>
  <counters></counters>
  <charges>
	  <charge>
      <name>TransportAmount</name>
      <display_name>Transport Charges</display_name>
    </charge>
	  <charge>
      <name>BridgeAmount</name>
      <display_name>Bridge Charges</display_name>
	    <charge_property>
        <name>CallType</name>
      </charge_property>
	    <charge_property>
        <name>Mode</name>
      </charge_property>
    </charge>
  </charges>
  <pipeline>
    <service_definition>metratech.com/audioconfconnection</service_definition>
    <product_view>metratech.com/audioconfconnection</product_view>
  </pipeline>
  <adjustment_type>
    <name>ConnectionMinutesAdjustment</name>
    <description>Audio Conference Connection Minutes Adjustment</description>
    <displayname>Audio Conference Connection Minutes Adjustment</displayname>
    <CalculationEngine>1</CalculationEngine>
    <supportsBulk>Y</supportsBulk>
    <DefaultAdjustmentDescription>
    <![CDATA[
      Minutes Adjustment for Conference call connection. Conference ID: '@ConferenceID'
     ]]>
    </DefaultAdjustmentDescription>

    <formula>
	    <![CDATA[
        Create Procedure DoAdjustmentCalc 
	        -- required inputs
	        @Minutes INTEGER,
	        -- non required inputs
	        @tax_federal DECIMAL,
	        @tax_state DECIMAL,
	        @tax_county DECIMAL,
	        @tax_local DECIMAL,
	        @tax_other DECIMAL,
	        @ConnectionMinutes DECIMAL,
	        @BridgeAmount DECIMAL,
	        @TransportAmount DECIMAL,
	        -- outputs
	        @AJ_BridgeAmount DECIMAL OUTPUT,
	        @AJ_TransportAmount DECIMAL OUTPUT,
	        @aj_tax_federal DECIMAL OUTPUT,
	        @aj_tax_state DECIMAL OUTPUT,
	        @aj_tax_county DECIMAL OUTPUT,
	        @aj_tax_local DECIMAL OUTPUT,
	        @aj_tax_other DECIMAL OUTPUT,
	        @TotalAdjustmentAmount DECIMAL OUTPUT
	        as
					declare @taxratio DECIMAL
					declare @totalcharge DECIMAL
					DECLARE @fuzz DECIMAL
          set @fuzz = 0.0001
	        set @totalcharge = @BridgeAmount+@TransportAmount
					set @AJ_BridgeAmount = CAST(@Minutes as DECIMAL) * round(@BridgeAmount/@ConnectionMinutes,2)
					set @AJ_TransportAmount = CAST(@Minutes as DECIMAL) * round(@TransportAmount/@ConnectionMinutes,2)
					set @TotalAdjustmentAmount = round((@AJ_BridgeAmount + @AJ_TransportAmount), 2)
					set @taxratio = @TotalAdjustmentAmount/(@totalcharge + @fuzz)
					set @aj_tax_federal = round(@tax_federal * @taxratio, 2)
					set @aj_tax_state = round(@tax_state * @taxratio, 2)
					set @aj_tax_county = round(@tax_county * @taxratio, 2)
	        set @aj_tax_local = round(@tax_local * @taxratio, 2)
					set @aj_tax_other = round(@tax_other * @taxratio, 2)
	    ]]>
    </formula>
    <applicabilityrules>
    </applicabilityrules>
    <reasoncodes>
      <reasoncode>RateCorrection</reasoncode>
      <reasoncode>Bankruptcy</reasoncode>
    </reasoncodes>
    <Kind>3</Kind>
    <required_inputs>
      <input_val
        name="Minutes"
        type="INTEGER"
        displayname="Number of minutes to adjust charges"
      />
    </required_inputs>
    <outputs>
      <output_val
        name="AJ_BridgeAmount"
        type="DECIMAL"
        displayname="Adjustment For Bridge Charge"
      />
      <output_val
        name="AJ_TransportAmount"
        type="DECIMAL"
        displayname="Adjustment For Transport Charge"
      />
      <output_val
        name="TotalAdjustmentAmount"
        type="DECIMAL"
        displayname="Total Adjustment Amount"
      />
        <output_val
        name="aj_tax_federal"
        type="DECIMAL"
        displayname="Adjustment to Federal Tax"
      />
      <output_val
        name="aj_tax_state"
        type="DECIMAL"
        displayname="Adjustment to State Tax"
      />
      <output_val
        name="aj_tax_county"
        type="DECIMAL"
        displayname="Adjustment to County Tax"
      />
      <output_val
        name="aj_tax_local"
        type="DECIMAL"
        displayname="Adjustment to Local Tax"
      />
      <output_val
        name="aj_tax_other"
        type="DECIMAL"
        displayname="Adjustment to Other Tax"
      />
    </outputs>
   </adjustment_type>
   <adjustment_type>
    <name>ConnectionFlatAdjustment</name>
    <description>Audio Conference Connection Flat Adjustment</description>
    <displayname>Audio Conference Connection Flat Adjustment</displayname>
    <CalculationEngine>1</CalculationEngine>
    <supportsBulk>Y</supportsBulk>
    <DefaultAdjustmentDescription>
    <![CDATA[
      Flat Adjustment for Conference call connection. Conference ID: '@ConferenceID'
     ]]>
    </DefaultAdjustmentDescription>
    <formula>
	    <![CDATA[
        Create Procedure DoAdjustmentCalc
	        -- required inputs
	        @BridgeAdjustmentAmount DECIMAL,
	        @TransportAdjustmentAmount DECIMAL,
	        -- non required inputs
	        @tax_federal DECIMAL,
	        @tax_state DECIMAL,
	        @tax_county DECIMAL,
	        @tax_local DECIMAL,
	        @tax_other DECIMAL,
	        @BridgeAmount DECIMAL,
	        @TransportAmount DECIMAL,
	        -- outputs
	        @AJ_BridgeAmount DECIMAL OUTPUT,
	        @AJ_TransportAmount DECIMAL OUTPUT,
	        @aj_tax_federal DECIMAL OUTPUT,
	        @aj_tax_state DECIMAL OUTPUT,
	        @aj_tax_county DECIMAL OUTPUT,
	        @aj_tax_local DECIMAL OUTPUT,
	        @aj_tax_other DECIMAL OUTPUT,
	        @TotalAdjustmentAmount DECIMAL OUTPUT
	        as
	        declare @taxratio DECIMAL
          declare @totalcharge DECIMAL
          DECLARE @fuzz DECIMAL
          set @fuzz = 0.0001
          if @BridgeAmount > 0.0
						set @AJ_BridgeAmount = @BridgeAdjustmentAmount
					if @TransportAmount > 0.0
						set @AJ_TransportAmount = @TransportAdjustmentAmount
			    set @TotalAdjustmentAmount = round((@AJ_BridgeAmount + @AJ_TransportAmount), 2)
			    set @totalcharge = @BridgeAmount+@TransportAmount
			    set @taxratio = @TotalAdjustmentAmount/(@totalcharge + @fuzz)
				  set @aj_tax_federal = round(@tax_federal * @taxratio, 2)
					set @aj_tax_state = round(@tax_state * @taxratio, 2)
					set @aj_tax_county = round(@tax_county * @taxratio, 2)
					set @aj_tax_local = round(@tax_local * @taxratio, 2)
					set @aj_tax_other = round(@tax_other * @taxratio, 2)
	    ]]>
    </formula>
    <applicabilityrules>
    </applicabilityrules>
    <reasoncodes>
      <reasoncode>Bankruptcy</reasoncode>
      <reasoncode>RateCorrection</reasoncode>
    </reasoncodes>
    <Kind>1</Kind>
    <required_inputs>
      <input_val
        name="BridgeAdjustmentAmount"
        type="DECIMAL"
        displayname="Bridge Amount adjustment"
      />
      <input_val
        name="TransportAdjustmentAmount"
        type="DECIMAL"
        displayname="Transport Amount adjustment"
      />
    </required_inputs>
    <outputs>
      <output_val
        name="AJ_BridgeAmount"
        type="DECIMAL"
        displayname="Adjustment For Bridge Charge"
      />
      <output_val
        name="AJ_TransportAmount"
        type="DECIMAL"
        displayname="Adjustment For Transport Charge"
      />
       <output_val
        name="TotalAdjustmentAmount"
        type="DECIMAL"
        displayname="Total Adjustment Amount"
      />
      <output_val
        name="aj_tax_federal"
        type="DECIMAL"
        displayname="Adjustment to Federal Tax"
      />
      <output_val
        name="aj_tax_state"
        type="DECIMAL"
        displayname="Adjustment to State Tax"
      />
      <output_val
        name="aj_tax_county"
        type="DECIMAL"
        displayname="Adjustment to County Tax"
      />
      <output_val
        name="aj_tax_local"
        type="DECIMAL"
        displayname="Adjustment to Local Tax"
      />
      <output_val
        name="aj_tax_other"
        type="DECIMAL"
        displayname="Adjustment to Other Tax"
      />
    </outputs>
  </adjustment_type>
   <adjustment_type>
    <name>ConnectionPercentAdjustment</name>
    <description>Audio Conference Connection Percent Adjustment</description>
    <displayname>Audio Conference Connection Percent Adjustment</displayname>
    <CalculationEngine>1</CalculationEngine>
    <supportsBulk>Y</supportsBulk>
    <DefaultAdjustmentDescription>
    <![CDATA[
      Percent Adjustment for Conference call connection. Conference ID: '@ConferenceID'
     ]]>
    </DefaultAdjustmentDescription>
    <formula>
	    <![CDATA[
       Create Procedure DoAdjustmentCalc
	        -- required inputs
	        @BridgeAdjustmentPercent DECIMAL,
	        @TransportAdjustmentPercent DECIMAL,
	        -- non required inputs
	        @BridgeAmount DECIMAL,
	        @TransportAmount DECIMAL,
	        @tax_federal DECIMAL,
	        @tax_state DECIMAL,
	        @tax_county DECIMAL,
	        @tax_local DECIMAL,
	        @tax_other DECIMAL,
	        -- outputs
	        @AJ_BridgeAmount DECIMAL OUTPUT,
	        @AJ_TransportAmount DECIMAL OUTPUT,
	        @aj_tax_federal DECIMAL OUTPUT,
	        @aj_tax_state DECIMAL OUTPUT,
	        @aj_tax_county DECIMAL OUTPUT,
	        @aj_tax_local DECIMAL OUTPUT,
	        @aj_tax_other DECIMAL OUTPUT,
	        @TotalAdjustmentAmount DECIMAL OUTPUT
	        as
	        declare @taxratio DECIMAL
          declare @totalcharge DECIMAL
          DECLARE @fuzz DECIMAL
          set @fuzz = 0.0001
	        set @AJ_BridgeAmount = round(@BridgeAmount * (@BridgeAdjustmentPercent * 0.01), 2)
          set @AJ_TransportAmount = round(@TransportAmount * (@TransportAdjustmentPercent * 0.01), 2)
          set @TotalAdjustmentAmount = round((@AJ_BridgeAmount + @AJ_TransportAmount), 2)
          set @totalcharge = @BridgeAmount+@TransportAmount
			    set @taxratio = @TotalAdjustmentAmount/(@totalcharge + @fuzz)
				  set @aj_tax_federal = round(@tax_federal * @taxratio, 2)
					set @aj_tax_state = round(@tax_state * @taxratio, 2)
					set @aj_tax_county = round(@tax_county * @taxratio, 2)
					set @aj_tax_local = round(@tax_local * @taxratio, 2)
					set @aj_tax_other = round(@tax_other * @taxratio, 2)
	    ]]>
    </formula>
     <applicabilityrules>
    </applicabilityrules>
    <reasoncodes>
      <reasoncode>Bankruptcy</reasoncode>
      <reasoncode>RateCorrection</reasoncode>
    </reasoncodes>
    <Kind>2</Kind>
    <required_inputs>
      <input_val
        name="BridgeAdjustmentPercent"
        type="DECIMAL"
        displayname="Bridge Charge Adjustment Percentage"
      />
      <input_val
        name="TransportAdjustmentPercent"
        type="DECIMAL"
        displayname="Transport Charge Adjustment Percentage"
      />
    </required_inputs>
    <outputs>
      <output_val
        name="AJ_BridgeAmount"
        type="DECIMAL"
        displayname="Adjustment For Bridge Charge"
      />
      <output_val
        name="AJ_TransportAmount"
        type="DECIMAL"
        displayname="Adjustment For Transport Charge"
      />
       <output_val
        name="TotalAdjustmentAmount"
        type="DECIMAL"
        displayname="Total Adjustment Amount"
      />
      <output_val
        name="aj_tax_federal"
        type="DECIMAL"
        displayname="Adjustment to Federal Tax"
      />
      <output_val
        name="aj_tax_state"
        type="DECIMAL"
        displayname="Adjustment to State Tax"
      />
      <output_val
        name="aj_tax_county"
        type="DECIMAL"
        displayname="Adjustment to County Tax"
      />
      <output_val
        name="aj_tax_local"
        type="DECIMAL"
        displayname="Adjustment to Local Tax"
      />
      <output_val
        name="aj_tax_other"
        type="DECIMAL"
        displayname="Adjustment to Other Tax"
      />
    </outputs>
  </adjustment_type>

</priceable_item>