<?xml version="1.0" encoding="utf-8"?>
<xmlconfig>
    <mtsysconfigdata>
        <effective_date ptype="DATETIME">1998-11-19T00:00:00Z</effective_date>
        <timeout ptype="INTEGER">30</timeout>
        <configfiletype>CONFIG_DATA</configfiletype>
    </mtsysconfigdata>
    <mtconfigdata>
        <version ptype="INTEGER">1</version>
        <processor>
            <name>ApplyTemplateProperties</name>
            <progid>MetraPipeline.ApplyTemplateProperties</progid>

            <condition>
			<![CDATA[
      
      CREATE PROCEDURE condition @_ExecutePlugin BOOLEAN OUTPUT,
													     @ApplyAccountTemplate BOOLEAN,
      													 @ActionType ENUM -- $ICE:('metratech.com/accountcreation','ActionType')$,
      													 @AncestorAccountID INTEGER,
      													 @OldAncestorAccountID INTEGER,
      													 @AncestorAccount NVARCHAR(510),
      													 @AncestorAccountNS NVARCHAR(80)
      													 
	    AS
	    -- only execute if 
	    -- ApplyAccountTemplateProperty is set to true.
	    -- AND enough information is present such that ancestor can be determined.
	    -- AND action is either ACCOUNT or BOTH AND new ancestor not equals to old encestor (for account updates).
	   
      IF 
      (
					(@ApplyAccountTemplate = TRUE) 
					AND 
					(
					 NOT((@AncestorAccountID IS NULL) AND (@AncestorAccount IS NULL OR @AncestorAccountNS IS NULL)) 
					)
					AND
					(
					  ((upper(CAST(@ActionType AS VARCHAR)) = 'ACCOUNT') OR (upper(CAST(@ActionType AS VARCHAR)) = 'BOTH'))
  				)
  				AND
  			  (
  			     (@OldAncestorAccountID IS NULL) OR (@OldAncestorAccountID <> @AncestorAccountID)
  			  )
				)
			  SET @_ExecutePlugin = TRUE
      ELSE
      	SET @_ExecutePlugin = FALSE
	    
      ]]></condition>
            <configdata>
                <Operation>Operation</Operation>
                <AccountID>_AccountID</AccountID>
    		<!-- Account Start Date is specified when we create an account -->
    		<AccountStartDate>accountstartdate</AccountStartDate>
    		<!--.. but in case of account update start date is hierarchy_startdate. -->
    		<hierarchy_startdate>hierarchy_startdate</hierarchy_startdate>
    		
                <AncestorAccountID>ancestorAccountID</AncestorAccountID>
                <AncestorAccount>ancestorAccount</AncestorAccount>
                <AncestorAccountNameSpace>ancestorAccountNS</AncestorAccountNameSpace>
                <OldAncestorAccountID>OldAncestorAccountID</OldAncestorAccountID>
                <UserName>username</UserName>
                <Namespace>name_space</Namespace>
                <AccountTypeID>acc_type_id</AccountTypeID>
            </configdata>
        </processor>
    </mtconfigdata>
</xmlconfig>