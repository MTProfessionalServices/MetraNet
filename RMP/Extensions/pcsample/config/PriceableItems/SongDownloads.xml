<?xml version="1.0" encoding="UTF-8"?>

<priceable_item>
  <name>Song Downloads</name>
  <description>Sample aggregate charge</description>
  <item_type>aggregate</item_type>
  <relationships>
    <parent></parent>
  </relationships>
  <parameter_table>metratech.com/songdownloads</parameter_table>
  <counters>
    <cpd>
      <name>TotalSongs</name>
      <display_name>Total songs downloaded</display_name>
      <service_property>TotalSongs</service_property>
      <preferred_counter_type>SumOfOneProperty</preferred_counter_type>
    </cpd>
    <cpd>
      <name>TotalBytes</name>
      <display_name>Total bytes downloaded</display_name>
      <service_property>TotalBytes</service_property>
      <preferred_counter_type>SumOfOneProperty</preferred_counter_type>
    </cpd>
    <counter>
      <name>TotalSongs</name>
      <type>SumOfOneProperty</type>
      <parameter>
        <name>A</name>
        <value>metratech.com/songdownloads_temp/songs</value>
      </parameter>
    </counter>
    <counter>
      <name>TotalBytes</name>
      <type>SumOfTwoProperties</type>
      <parameter>
        <name>A</name>
        <value>metratech.com/songdownloads_temp/mp3bytes</value>
      </parameter>
      <parameter>
        <name>B</name>
        <value>metratech.com/songdownloads_temp/wavbytes</value>
      </parameter>
    </counter>
  </counters>
  <charges>
	<charge>
		<name>ConnectionFee</name>
		<display_name>Connection Fee Charge</display_name>
	</charge>
  </charges>
  <pipeline>
    <service_definition>metratech.com/songdownloads</service_definition>
    <product_view>metratech.com/songdownloads</product_view>
  </pipeline>
   <adjustment_type>
    <name>ConnectionFeeFlatAdjustment</name>
    <description>Connection Fee Flat Adjustment</description>
    <displayname>Connection Fee Flat Adjustment Display</displayname>
    <CalculationEngine>1</CalculationEngine>
    <supportsBulk>N</supportsBulk>
    <DefaultAdjustmentDescription>
      <![CDATA[
      Connection Fee flat adjustment of Song Downloads with description: '@Description'
     ]]>
    </DefaultAdjustmentDescription>
    <formula>
	    <![CDATA[
       Create Procedure CalcConnectionFeeAdjustment
	        -- required inputs
	        @ConnectionFeeAdjustmentAmount DECIMAL
	         -- non required inputs
	        @ConnectionFee DECIMAL,
	        @tax_federal DECIMAL,
	        @tax_state DECIMAL,
	        @tax_county DECIMAL,
	        @tax_local DECIMAL,
	        @tax_other DECIMAL,
	        -- outputs
	        @AJ_ConnectionFee DECIMAL OUTPUT,
	        @aj_tax_federal DECIMAL OUTPUT,
	        @aj_tax_state DECIMAL OUTPUT,
	        @aj_tax_county DECIMAL OUTPUT,
	        @aj_tax_local DECIMAL OUTPUT,
	        @aj_tax_other DECIMAL OUTPUT,
	        @TotalAdjustmentAmount DECIMAL OUTPUT
	        As
	        declare @taxratio DECIMAL
          declare @totalcharge DECIMAL
          DECLARE @fuzz DECIMAL
          set @fuzz = 0.0001
	        if @ConnectionFee > 0.0
						set @AJ_ConnectionFee = @ConnectionFeeAdjustmentAmount
          set @TotalAdjustmentAmount = round(@AJ_ConnectionFee, 2)
          set @totalcharge = @ConnectionFee
			    set @taxratio = @TotalAdjustmentAmount/(@totalcharge + @fuzz)
				  set @aj_tax_federal = round(@tax_federal * @taxratio, 2)
					set @aj_tax_state = round(@tax_state * @taxratio, 2)
					set @aj_tax_county = round(@tax_county * @taxratio, 2)
					set @aj_tax_local = round(@tax_local * @taxratio, 2)
					set @aj_tax_other = round(@tax_other * @taxratio, 2)
        ]]>
    </formula>
    <applicabilityrules>
      <rule>IsTransactionPostbill</rule>
    </applicabilityrules>
    <reasoncodes>
      <reasoncode>Bankruptcy</reasoncode>
      <reasoncode>RateCorrection</reasoncode>
    </reasoncodes>
    <Kind>1</Kind>
    
    <required_inputs>
      <input_val
        name="ConnectionFeeAdjustmentAmount"
        type="DECIMAL"
        displayname="Adjustment Amount for Connection Fee"
      />
     </required_inputs>
   
    <outputs>
      <output_val
        name="AJ_ConnectionFee"
        type="DECIMAL"
        displayname="Adjustment For Connection Fee"
      />
       <output_val
        name="TotalAdjustmentAmount"
        type="DECIMAL"
        displayname="Connection Fee Total Adjustment Amount"
      />
       <output_val
        name="aj_tax_federal"
        type="DECIMAL"
        displayname="Adjustment to Federal Tax"
      />
      <output_val
        name="aj_tax_state"
        type="DECIMAL"
        displayname="Adjustment to State Tax"
      />
      <output_val
        name="aj_tax_county"
        type="DECIMAL"
        displayname="Adjustment to County Tax"
      />
      <output_val
        name="aj_tax_local"
        type="DECIMAL"
        displayname="Adjustment to Local Tax"
      />
      <output_val
        name="aj_tax_other"
        type="DECIMAL"
        displayname="Adjustment to Other Tax"
      />
    </outputs>
   </adjustment_type>
   <adjustment_type>
    <name>ConnectionFeePercentAdjustment</name>
    <description>Connection Fee Percentage Adjustment</description>
    <displayname>Connection Fee Percentage Adjustment Display</displayname>
    <CalculationEngine>1</CalculationEngine>
    <supportsBulk>N</supportsBulk>
     <DefaultAdjustmentDescription>
      <![CDATA[
      Connection Fee percent adjustment of Song Downloads with description: '@Description'
     ]]>
    </DefaultAdjustmentDescription>
    <formula>
	    <![CDATA[
      Create Procedure CalcPercentConnectFeeAdjust
	        -- required inputs
	        @ConnectionFeePercent DECIMAL,
	         -- non required inputs
	        @ConnectionFee DECIMAL,
	        @tax_federal DECIMAL,
	        @tax_state DECIMAL,
	        @tax_county DECIMAL,
	        @tax_local DECIMAL,
	        @tax_other DECIMAL,
	        -- outputs
	        @AJ_ConnectionFee  DECIMAL OUTPUT,
	        @aj_tax_federal DECIMAL OUTPUT,
	        @aj_tax_state DECIMAL OUTPUT,
	        @aj_tax_county DECIMAL OUTPUT,
	        @aj_tax_local DECIMAL OUTPUT,
	        @aj_tax_other DECIMAL OUTPUT,
	        @TotalAdjustmentAmount DECIMAL OUTPUT
	        as
	        declare @taxratio DECIMAL
          declare @totalcharge DECIMAL
          DECLARE @fuzz DECIMAL
          set @fuzz = 0.0001
          set @AJ_ConnectionFee  = round(@ConnectionFee*@ConnectionFeePercent*0.01, 2)
          set @TotalAdjustmentAmount = @AJ_ConnectionFee
          set @totalcharge = @ConnectionFee
			    set @taxratio = @TotalAdjustmentAmount/(@totalcharge + @fuzz)
          set @aj_tax_federal = round(@tax_federal * @taxratio, 2)
					set @aj_tax_state = round(@tax_state * @taxratio, 2)
					set @aj_tax_county = round(@tax_county * @taxratio, 2)
					set @aj_tax_local = round(@tax_local * @taxratio, 2)
					set @aj_tax_other = round(@tax_other * @taxratio, 2)
        ]]>
    </formula>
    <applicabilityrules>
      <rule>IsTransactionPostbill</rule>
    </applicabilityrules>
    <reasoncodes>
      <reasoncode>Bankruptcy</reasoncode>
      <reasoncode>RateCorrection</reasoncode>
    </reasoncodes>
    <Kind>2</Kind>
    
    <required_inputs>
      <input_val
        name="ConnectionFeePercent"
        type="DECIMAL"
        displayname="Adjustment Percentage for Connection Fee"
      />
    </required_inputs>
   
    <outputs>
      <output_val
        name="AJ_ConnectionFee"
        type="DECIMAL"
        displayname="Adjustment For Connection Fee"
      />
       <output_val
        name="TotalAdjustmentAmount"
        type="DECIMAL"
        displayname="Connection Fee Total Adjustment Amount"
      />
      <output_val
        name="aj_tax_federal"
        type="DECIMAL"
        displayname="Adjustment to Federal Tax"
      />
      <output_val
        name="aj_tax_state"
        type="DECIMAL"
        displayname="Adjustment to State Tax"
      />
      <output_val
        name="aj_tax_county"
        type="DECIMAL"
        displayname="Adjustment to County Tax"
      />
      <output_val
        name="aj_tax_local"
        type="DECIMAL"
        displayname="Adjustment to Local Tax"
      />
      <output_val
        name="aj_tax_other"
        type="DECIMAL"
        displayname="Adjustment to Other Tax"
      />
  </outputs>
   </adjustment_type>
   
   <adjustment_type>
    <name>SongDownloadsRebillAdjustment</name>
    <description>Song Downloads Rebill Adjustment</description>
    <displayname>Song Downloads Rebill Adjustment</displayname>
    <CalculationEngine>1</CalculationEngine>
    <supportsBulk>N</supportsBulk>
     <DefaultAdjustmentDescription>
      <![CDATA[
      Adjustment caused by reassignment of Song Downloads with description: '@Description'
     ]]>
    </DefaultAdjustmentDescription>
    <formula>
	    <![CDATA[
      Create Procedure CalcRebillAdjustment
	         -- non required inputs
	        @CompoundPrebillAdjedAmt DECIMAL,
	        @ConnectionFee DECIMAL,
	        @tax_federal DECIMAL,
	        @tax_state DECIMAL,
	        @tax_county DECIMAL,
	        @tax_local DECIMAL,
	        @tax_other DECIMAL,
	        -- outputs
	        @AJ_ConnectionFee  DECIMAL OUTPUT,
 	        @aj_tax_federal DECIMAL OUTPUT,
	        @aj_tax_state DECIMAL OUTPUT,
	        @aj_tax_county DECIMAL OUTPUT,
	        @aj_tax_local DECIMAL OUTPUT,
	        @aj_tax_other DECIMAL OUTPUT,
	        @TotalAdjustmentAmount DECIMAL OUTPUT
	        as
          set @AJ_ConnectionFee  = 0.0
          set @TotalAdjustmentAmount = @CompoundPrebillAdjedAmt
          set @aj_tax_federal = @tax_federal
          set @aj_tax_state = @tax_state
          set @aj_tax_county =@tax_county
          set @aj_tax_local = @tax_local
          set @aj_tax_other = @tax_other
        ]]>
    </formula>
    <applicabilityrules>
      <rule>IsTransactionPostbill</rule>
    </applicabilityrules>
    <reasoncodes>
       <reasoncode>Rebill</reasoncode>
    </reasoncodes>
    <Kind>4</Kind>
    <required_inputs>
    </required_inputs>
    <outputs>
      <output_val
        name="AJ_ConnectionFee"
        type="DECIMAL"
        displayname="Adjustment For Connection Fee"
      />
       <output_val
        name="TotalAdjustmentAmount"
        type="DECIMAL"
        displayname="Connection Fee Total Adjustment Amount"
      />
       <output_val
        name="aj_tax_federal"
        type="DECIMAL"
        displayname="Adjustment to Federal Tax"
      />
      <output_val
        name="aj_tax_state"
        type="DECIMAL"
        displayname="Adjustment to State Tax"
      />
      <output_val
        name="aj_tax_county"
        type="DECIMAL"
        displayname="Adjustment to County Tax"
      />
      <output_val
        name="aj_tax_local"
        type="DECIMAL"
        displayname="Adjustment to Local Tax"
      />
      <output_val
        name="aj_tax_other"
        type="DECIMAL"
        displayname="Adjustment to Other Tax"
      />
  </outputs>
   </adjustment_type>
</priceable_item>
