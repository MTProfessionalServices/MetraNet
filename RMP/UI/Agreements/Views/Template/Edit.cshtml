@using MetraTech.Agreements.Models
@using MetraTech.DomainModel.Enums
@model AgreementTemplateViewModel

@{
  Layout = "../Shared/_AgreementTemplateLayout.cshtml";
}

@section Scripts {

  <script type="text/javascript">
  function openWindow() {
  var page = "http://" + document.domain + "/MetraNet/SpecCharacteristics/Index/" + "@Model.AgreementTemplateId" + "?EntityType=" + "@((int)EnumHelper.GetCSharpEnum((int)EnumHelper.GetDbValueByEnum(MetraTech.DomainModel.Enums.Core.Global.EntityType.AgreementTemplate)))";
  var $dialog = $('<div></div>')
               .html('<iframe style="border: 0px; " src="' + page + '" width="100%" height="100%"></iframe>')
               .dialog({
                   autoOpen: false,
                   modal: true,
                   height: 725,
                   width: 700,
                   title: '@ViewContext.HttpContext.GetGlobalResourceObject("Views_Template_Edit", "TEXT_SHARED_PROPERTIES_HEADER")'
               });
   $dialog.dialog('open');
  }

    $(document).ready(function () {

      var thisTemplate = @Html.Raw(Json.Encode(Model));
      var productOfferingType = @Convert.ToInt32(EntityTypeEnum.ProductOffering);
      
      function getDataFromForm() {
        var field;
        var docField;
        for (field in thisTemplate.CoreTemplateProperties) {
          docField = "CoreTemplateProperties_" + field;
          if ((document.getElementById(docField) != null) &&
            (document.getElementById(docField).value != ""))
            thisTemplate.CoreTemplateProperties[field] = document.getElementById(docField).value;
        }
        for (field in thisTemplate.CoreAgreementProperties) {
          docField = "CoreAgreementProperties_" + field;
          if ((document.getElementById(docField) != null) &&
            (document.getElementById(docField).value != ""))
            thisTemplate.CoreAgreementProperties[field] = document.getElementById(docField).value;
        }
        // Modify the form template to contain all product offerings in the IncludedProductOfferings div
        thisTemplate.AgreementEntities.AgreementEntityList = [];
        addProductOfferingsToAgreemenEntityList(thisTemplate.AgreementEntities.AgreementEntityList);
        return true;
      }

      // Override the submit handler for the form, to submit using AJAX.
      $("#myform").submit(function () {
          getDataFromForm();
        $.ajax({
          url: '@ViewBag.ApiUrl' + '@ViewBag.TemplateId',
          type: 'PUT',
          contentType: 'application/json; charset=utf-8',
          data: JSON.stringify(thisTemplate),
          //data:("#myform").serialize(),
          success: function (data) {
            location = '@Url.Content(@ViewBag.NextPage)' + data.AgreementTemplateId;
          },
          error: function (xhr) {
              if (xhr.status == 500) {
                  location = '@Url.Content(@ViewBag.ServerErrorPage)' + '@ViewBag.TemplateId';
              }
              $('#message').html('@ViewContext.HttpContext.GetGlobalResourceObject("Views_Template_Edit", "TEXT_ERROR_MESSAGE_1")' + thisTemplate.AgreementTemplateId + '@ViewContext.HttpContext.GetGlobalResourceObject("Views_Template_Edit", "TEXT_ERROR_MESSAGE_2")' + xhr.responseText);
              //location = '@Url.Content("~/Template/Error")';
          }
        });
        return false;
      });
    });
  </script>
}


<script src="@Url.Content("~/Scripts/jquery.validate.min.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Scripts/jquery.validate.unobtrusive.min.js")" type="text/javascript"></script>

<div id="content" class="container_12 clearfix">
  <header>
    <div class="page-title grid_7">
      <h1>
        @ViewContext.HttpContext.GetGlobalResourceObject("Views_Template_Edit", "TEXT_EDIT_AGREEMENT_TEMPLATE")
      </h1>
    </div>

    <div class="page-actions grid_5 align-alt float">
      <ul class="button-row inline tspace">
        <li>
          <a href="" class="btn help">
            @ViewContext.HttpContext.GetGlobalResourceObject("Views_Template_Edit", "TEXT_HELP")
          </a>
        </li>
      </ul>
    </div>
    <div class="notifications grid_12 clearfix">
      <div class="alert page-help rounded-med">
        <div class="inner">
          <h5>
            @ViewContext.HttpContext.GetGlobalResourceObject("Views_Template_Edit", "TEXT_HELP_TITLE")
          </h5>
          <p>
            @ViewContext.HttpContext.GetGlobalResourceObject("Views_Template_Edit", "TEXT_HELP_CONTENT")
          </p>
          <a class="close-alert" href="">
            @ViewContext.HttpContext.GetGlobalResourceObject("Views_Template_Edit", "TEXT_HELP_CLOSE")
          </a>
        </div>
      </div>
      <!-- Other notifications go here-->
    </div><!--/.notifications-->
  </header>
<div class="clear"></div>
<form id="myform" action="">
  @Html.ValidationSummary(true)
  <fieldset>
    @Html.EditorForModel()
    <div id="message" class="errorMessage"></div>
  </fieldset>
  @Html.Partial("_AddProductOfferingsPartial")
  <p>
    <button type="button" class="btn lg bold" onclick="openWindow()">
      @ViewContext.HttpContext.GetGlobalResourceObject("Views_Template_Edit", "TEXT_SHARED_PROPERTIES_BUTTON")
    </button>
    <button type="submit" class="btn lg bold">
      @ViewContext.HttpContext.GetGlobalResourceObject("Views_Template_Edit", "TEXT_SAVE_BUTTON")
    </button>
  </p>
</form>
  <div>
    @Html.ActionLink(ViewContext.HttpContext.GetGlobalResourceObject("Views_Template_Edit", "TEXT_BACK").ToString(), "Index")
  </div>

</div>
