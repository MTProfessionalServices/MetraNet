<?xml version="1.0" encoding="utf-8"?>
<MetraFlowScript>
    <Name>InvoiceAccountInternal</Name>
    <Description>Generate usage summaries, adjustment summaries and balance forward amounts for invoice calculation.</Description>
    <Parameters>
        <Parameter>
            <Name>TEMP_DIR</Name>
            <SyntaxCheckValue>C:\Temp</SyntaxCheckValue>
            <Description>Directory in which to store temporary files.</Description>
        </Parameter>
        <Parameter>
            <Name>ID_BILLGROUP</Name>
            <SyntaxCheckValue>1000</SyntaxCheckValue>
            <Description>Billing group for which invoices are being processed.</Description>
        </Parameter>
    </Parameters>
    <Script>
      <![CDATA[
avi:select[baseQuery="SELECT av.id_acc as avi_id_acc, c_billable as avi_c_billable, c_currency as avi_c_currency 
FROM 
t_billgroup_member bgm
INNER LOOP JOIN t_av_internal av on av.id_acc=bgm.id_acc
WHERE
bgm.id_billgroup=%%ID_BILLGROUP%%
AND
{fn mod(bgm.id_acc, %%NUMPARTITIONS%%)} = %%PARTITION%%",
partitionConstraint="Database"];

avi_part:hashpart[key="avi_id_acc",
partitionConstraint="Database"];

avi_coll:coll[];

avi_write:sequential_file_write[filename="%%TEMP_DIR%%\invoice_t_av_internal_%1%.mfd"];

avi -> avi_part -> avi_coll -> avi_write;
]]></Script>
</MetraFlowScript>