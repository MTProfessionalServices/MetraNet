<xmlconfig>
  <mtsysconfigdata>
    <effective_date ptype="DATETIME">1998-11-19T00:00:00Z</effective_date>
    <timeout ptype="INTEGER">30</timeout>
    <configfiletype>CONFIG_DATA</configfiletype>
  </mtsysconfigdata>

  <mtconfigdata>

 <version ptype="INTEGER">1</version>
 <!-- First processor configuration -->
 <processor>
  <name>CalcOverusedPorts</name>
  <progid>MetraPipeline.MTSQLInterpreter.1</progid>
  <description>Calculates Actual Number of Overused Ports</description>
	
	<!--
  <autotest>
    <file>calcportstest.xml</file>
  </autotest>
  -->

  <inputs>
    
  </inputs>

  <outputs>
    
  </outputs>

  <!-- Processor specific configuration data -->
  <configdata>
 
  <Program><![CDATA[
		
			CREATE PROCEDURE calcports 		@ScheduledConnections 									INTEGER
																							@ActualNumConnections 				INTEGER
																							@UserNumConnections 					INTEGER
																							@OverusedExcludeRoles 				BOOLEAN
																							@OverusedPortChargeDef 				ENUM  -- $ICE:('metratech.com/audioconfcommon','PortChargeDef')$
																							@OverusedThresholdFree 				INTEGER
																							@OverusedAdvancedPercentage 	INTEGER
																							@OverusedPortDelta 						INTEGER
																							@NumOverusedPorts 						INTEGER OUTPUT
																							@OverUsedExcludeRoles					BOOLEAN
			AS
			DECLARE @PortsNotUsed INTEGER;
			DECLARE @strChargeDef VARCHAR;
			SET @strChargeDef = CAST(@OverusedPortChargeDef AS VARCHAR);
			DECLARE @AdvancedCalc INTEGER;
			DECLARE @NumUsedPorts INTEGER;
			DECLARE @PortsUseType VARCHAR;
			DECLARE @NumConnections INTEGER;
			SET @NumOverusedPorts = 0; 
			SET @PortsUseType = CASE WHEN (@ActualNumConnections > @ScheduledConnections) THEN 'Overused' ELSE 'Underused' END;
			IF @PortsUseType = 'Underused'
				RETURN;
			PRINT 'OverUsedExcludeRoles';
			PRINT CAST(@OverUsedExcludeRoles AS VARCHAR);
			PRINT 'UserNumConnections';
			PRINT CAST(@UserNumConnections AS VARCHAR);
			PRINT 'ActualNumConnections';
			PRINT CAST(@ActualNumConnections AS VARCHAR);
			SET @NumConnections = CASE WHEN (@OverUsedExcludeRoles) THEN @UserNumConnections ELSE @ActualNumConnections END;
			PRINT 'Connections used (for overused ports calculation)';
			PRINT CAST(@NumConnections AS VARCHAR);
			SET @PortsNotUsed = @NumConnections - @ScheduledConnections;
				PRINT CAST(@PortsNotUsed AS VARCHAR)
			SET @AdvancedCalc = @NumConnections - (@ScheduledConnections * @OverusedAdvancedPercentage / 100);
			SET @NumOverusedPorts =
				CASE
					WHEN (@strChargeDef = 'Simple')
						THEN @PortsNotUsed
					WHEN @strChargeDef = 'Threshold'
						THEN @PortsNotUsed - @OverusedThresholdFree
					WHEN @strChargeDef = 'Advanced' AND @PortsNotUsed > @OverusedPortDelta
						THEN @AdvancedCalc
					ELSE 0
				END;
			SET @NumOverusedPorts = CASE WHEN @NumOverusedPorts > 0 THEN @NumOverusedPorts ELSE 0 END;
	 
  ]]></Program> 
    
  </configdata>

 </processor>

  </mtconfigdata>

</xmlconfig>
